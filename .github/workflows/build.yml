name: Build Cavian VCV Rack Plugin

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        platform:
          - os: ubuntu-latest
            name: Linux
          - os: macos-15-intel   # Intel/x64 runner
            name: macOS-Intel
          - os: macos-latest     # ARM/arm64 runner
            name: macOS-ARM
          - os: windows-latest
            name: Windows
    
    runs-on: ${{ matrix.platform.os }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get Rack SDK (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://vcvrack.com/downloads/Rack-SDK-2.6.6-lin-x64.zip
          unzip Rack-SDK-2.6.6-lin-x64.zip
      
      - name: Get Rack SDK (macOS-Intel)
        if: matrix.platform.name == 'macOS-Intel'
        run: |
          wget https://vcvrack.com/downloads/Rack-SDK-2.6.6-mac-x64.zip
          unzip Rack-SDK-2.6.6-mac-x64.zip
      
      - name: Get Rack SDK (macOS-ARM)
        if: matrix.platform.name == 'macOS-ARM'
        run: |
          wget https://vcvrack.com/downloads/Rack-SDK-2.6.6-mac-arm64.zip
          unzip Rack-SDK-2.6.6-mac-arm64.zip
      
      - name: Get Rack SDK (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://vcvrack.com/downloads/Rack-SDK-2.6.6-win-x64.zip" -OutFile Rack-SDK.zip
          Expand-Archive Rack-SDK.zip -DestinationPath .
        shell: powershell
      
      - name: Install jq (macOS dependency for make dep)
        if: runner.os == 'macOS'
        run: brew install jq
      
      - name: Build plugin
        run: |
          export RACK_DIR=$GITHUB_WORKSPACE/Rack-SDK
          make clean
          make dep
          make dist
        shell: bash
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.name }}-build
          path: dist/*.vcvplugin
