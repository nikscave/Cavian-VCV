name: Build Cavian VCV Rack Plugin

on:
  workflow_dispatch:
  # Optional: add these for automatic builds on push/PR
  # push:
  #   branches: [ main ]
  # pull_request:

jobs:
  build:
    strategy:
      matrix:
        platform:
          - os: ubuntu-latest
            name: Linux
          - os: macos-15-intel   # Updated: replacement for deprecated macos-13
            name: macOS-Intel
            sdk_arch: x64
          - os: macos-latest     # ARM runner (already future-proof)
            name: macOS-ARM
            sdk_arch: arm64
          - os: windows-latest
            name: Windows
    
    runs-on: ${{ matrix.platform.os }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get Rack SDK (Linux)
        if: runner.os == 'Linux'
        run: |
          wget https://vcvrack.com/downloads/Rack-SDK-2.6.6-lin-x64.zip
          unzip Rack-SDK-2.6.6-lin-x64.zip
      
      - name: Get Rack SDK (macOS)
        if: runner.os == 'macOS'
        run: |
          wget https://vcvrack.com/downloads/Rack-SDK-2.6.6-mac-${{ matrix.sdk_arch }}.zip
          unzip Rack-SDK-2.6.6-mac-${{ matrix.sdk_arch }}.zip
      
      - name: Get Rack SDK (Windows)
        if: runner.os == 'Windows'
        run: |
          Invoke-WebRequest -Uri "https://vcvrack.com/downloads/Rack-SDK-2.6.6-win-x64.zip" -OutFile Rack-SDK.zip
          Expand-Archive Rack-SDK.zip -DestinationPath .
        shell: powershell
      
      - name: Install jq (macOS dependency for make dep)
        if: runner.os == 'macOS'
        run: brew install jq
      
      - name: Build plugin
        run: |
          export RACK_DIR=$GITHUB_WORKSPACE/Rack-SDK
          make clean
          make dep     # Explicitly fetch dependencies
          make dist
        shell: bash
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.name }}-build
          path: dist/*.vcvplugin
