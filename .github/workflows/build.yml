name: Build Cavian VCV Rack Plugin

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win-x64
          - os: ubuntu-latest
            platform: lin-x64
          - os: macos-15-intel
            platform: mac-x64
          - os: macos-latest
            platform: mac-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up MSYS2 (Windows)
        if: matrix.platform == 'win-x64'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            unzip

      - name: Set up dependencies (Linux)
        if: matrix.platform == 'lin-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libasound2-dev

      - name: Download Rack SDK (Windows)
        if: matrix.platform == 'win-x64'
        shell: msys2 {0}
        run: |
          curl -fL -H "User-Agent: GitHubActions" \
          https://vcvrack.com/downloads/Rack-SDK-2.6.6-${{ matrix.platform }}.zip \
          -o sdk.zip
          unzip sdk.zip

      - name: Download Rack SDK (non-Windows)
        if: matrix.platform != 'win-x64'
        shell: bash
        run: |
          curl -fL -H "User-Agent: GitHubActions" \
          https://vcvrack.com/downloads/Rack-SDK-2.6.6-${{ matrix.platform }}.zip \
          -o sdk.zip
          unzip sdk.zip

      - name: Verify SDK contents (Windows)
        if: matrix.platform == 'win-x64'
        shell: msys2 {0}
        run: |
          ls -l sdk.zip
          ls Rack-SDK
          test -f Rack-SDK/plugin.mk

      - name: Verify SDK contents (non-Windows)
        if: matrix.platform != 'win-x64'
        run: |
          ls -l sdk.zip
          ls Rack-SDK
          test -f Rack-SDK/plugin.mk

      - name: Build plugin (Windows)
        if: matrix.platform == 'win-x64'
        shell: msys2 {0}
        run: make dist RACK_DIR=Rack-SDK

      - name: Build plugin (non-Windows)
        if: matrix.platform != 'win-x64'
        run: make dist RACK_DIR=Rack-SDK

      - name: Debug - List files
        if: always()
        shell: bash
        run: |
          echo "=== Current directory ==="
          pwd
          ls -la
          echo "=== Checking for dist directory ==="
          ls -la dist/ || echo "dist/ directory does not exist"
          echo "=== Looking for .vcvplugin files ==="
          find . -name "*.vcvplugin" || echo "No .vcvplugin files found"

      - name: Debug - Check compiler (Windows)
        if: matrix.platform == 'win-x64'
        shell: msys2 {0}
        run: |
          echo "=== Checking MinGW version ==="
          x86_64-w64-mingw32-g++ --version || echo "MinGW not found"
          echo "=== Checking for DLL dependencies ==="
          if [ -f "plugin.dll" ]; then
            objdump -p plugin.dll | grep "DLL Name:" || echo "Could not check DLL dependencies"
          fi
          echo "=== Checking if libwinpthread is dynamically linked ==="
          if [ -f "plugin.dll" ]; then
            if objdump -p plugin.dll | grep -q "libwinpthread-1.dll"; then
              echo "WARNING: libwinpthread-1.dll is dynamically linked (may be OK)"
            else
              echo "libwinpthread is statically linked"
            fi
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-plugin
          path: dist/*.vcvplugin
